name: CI-CD (Trace)

on:
  push:
    branches: [ "develop" ]
  workflow_dispatch:

jobs:
  build-and-push:
    name: Build & Push Docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: 17
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean build --info

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx (docker-container)
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver: docker-container

      - name: Build and push (latest)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/trace:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

    outputs:
      image: ${{ secrets.DOCKERHUB_USERNAME }}/trace:latest

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push
    if: ${{ github.ref == 'refs/heads/develop' }}
    steps:
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy (pull & restart)
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/trace:latest

          # 앱 환경변수(Secrets)
          SPRING_PROFILES_ACTIVE: ${{ secrets.SPRING_PROFILES_ACTIVE }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          SPRING_DATA_REDIS_HOST: ${{ secrets.SPRING_DATA_REDIS_HOST }}
          SPRING_DATA_REDIS_PORT: ${{ secrets.SPRING_DATA_REDIS_PORT }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

          # AWS/스토리지/푸시
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}

          # 고정값
          CONTAINER: trace-app
          PORT_MAP: 80:5000
        run: |
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << EOF
          set -e

          echo "[Deploy] Pull image: ${IMAGE}"
          docker pull ${IMAGE}

          echo "[Deploy] Stop & remove old container if exists"
          if docker ps -a --format '{{.Names}}' | grep -w ${CONTAINER} >/dev/null 2>&1; then
            docker stop ${CONTAINER} || true
            docker rm ${CONTAINER} || true
          fi

          echo "[Deploy] Run new container"
          docker run -d --name ${CONTAINER} -p ${PORT_MAP} \
            --restart unless-stopped \
            -e SPRING_PROFILES_ACTIVE="${SPRING_PROFILES_ACTIVE}" \
            -e SPRING_DATA_REDIS_HOST="${SPRING_DATA_REDIS_HOST}" \
            -e SPRING_DATA_REDIS_PORT="${SPRING_DATA_REDIS_PORT}" \
            -e KAKAO_CLIENT_ID="${KAKAO_CLIENT_ID}" \
            -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
            -e DB_HOST="${DB_HOST}" \
            -e DB_PASSWORD="${DB_PASSWORD}" \
            -e JWT_SECRET="${JWT_SECRET}" \
            -e AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY}" \
            -e AWS_SECRET_ACCESS_KEY="${AWS_SECRET_KEY}" \
            -e FIREBASE_SERVICE_ACCOUNT_KEY="${FIREBASE_SERVICE_ACCOUNT_KEY}" \
            ${IMAGE}

          echo "[Deploy] Show logs (tail)"
          docker logs --tail=200 ${CONTAINER}

          # 실패 시 바로 알 수 있게 상태 체크(선택)
          STATUS=\$(docker inspect ${CONTAINER} --format '{{.State.Status}}')
          if [ "\$STATUS" != "running" ]; then
            docker logs --tail=300 ${CONTAINER}
            exit 1
          fi
          EOF

      - name: Health check
        run: |
          curl -I --max-time 10 http://${{ secrets.EC2_HOST }} || true
